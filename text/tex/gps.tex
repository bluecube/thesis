\chapter{GPS}
\label{chap:gps}

This chapter contains a overview of Global Positioning System and
its basic operation, that will be later used to develop methods for using GPS
measurements in Monte Carlo localization.

First principles of GPS are discussed, followed by description of methods for
obtaining receiver position and velocity,
error sources of GPS measurements and methods of dealing with these errors.
Lastly this chapter deals with communication with consumer grade GPS receivers
and briefly also with other position systems than GPS.

This chapter is based mainly on chapters 2 and 7 of \cite{kaplan06}, unless other source is cited.\todo{Is this OK?}

\section{Basic Description}

Global Positioning System is a global navigation satellite system (GNSS)
developed and operated by U.S. military.
GPS provides three dimensional position and velocity measurements as well as
precise time source for every place on earth with direct satellite visibility.

GPS consists of a constellation of at least 24 satellites (space vehicles, SVs),
control segment and end-user receivers.

The satellites are orbiting in six nearly circular orbits approximately \SI{20200}{\kilo\meter}
above Earth surface.
The satellite constellation is still being modernized \cite{gps-modernization-www}
and new satellites are being launched.
Several GPS signals with different properties are available and more will become available
with modernized satellites,
but generally all these signals can be divided to encrypted military signals 
(Precise Positioning Service) and unencrypted
civilian signals (Standard Positioning Service).
The civilian signals are available worldwide without any limitations.


GPS is often taken as a simple and reliable mean of navigation,
but the especially the unencrypted signals are susceptible to spoofing attacks \cite{tippenhauer11}.


Control segment consists of a network of ground facilities and is responsible for
monitoring the satellite constellation and send commands and data to the satellites.

%\section{History}
%Prior to development of GPS, a satellite navigation system called Transit was operational
%since 1964.
%Transit measured 2D positions of stationary or slow moving receivers based on
%Doppler shifts of the satellite signal \cite{transit-www}.


\section{Operation Principles}

\subsection{Time of Arrival measurements}

GPS calculates position by measuring the time it takes for a signal
emitted from a known position to reach reach the receiver.

Each GPS satellite transmits a pseudo random sequence (PRN signal),
containing timing information.
The receiver is able to replicate and match this sequence and therefore
is able to determine the transmission time of the signal.

If the position of satellites is known and all clock in the system are
synchronized, the position of the receiver
can be calculated as an intersection of at least three spheres centered around the satellites
and with radius corresponding to signal time of flight.

In reality, receiver clock offset needs to be calculated
during localization witch adds a new dimension to position determination.

\subsection{Time and GPS}

One of the functions of GPS system is a dissemination of precise time.
%This is necessary to calculate position

There are three basic time frames appearing in the GPS system.

\subsubsection{GPS System Time}

GPS System Time is a paper time scale based on atomic clock standards in GPS
satellites and on the ground.
This time standard is not directly available neither in SVs or in user receivers.

It is specified by a week number -- number of Saturday/Sunday midnights since week 0
that started on January, 6th 1980 -- and time of week in seconds.

GPS system time is related to UTC.
It is a continuous time scale, not adjusted for leap seconds
and it is required to be within \SI{1}{\micro\second} from UTC modulo \SI{1}{\second}.

\subsubsection{SV Time}
SV Time is a value that satellites transmit in their ranging signals,
obtained from the satellite's atomic clock.
Although the atomic clock standards are highly stable, the offset between SV
Time and GPS System Time may reach up to \SI{1}{\milli\second} (equivalent to
\SI{300}{\kilo\meter} of measurement error).

Values of this offset are calculated by the control segment
and broadcast by the satellites, or downloaded with precise ephemeris
(see section \ref{sec:gps-ephemeris}).
Because of this we can assume that this value is known, although not
with absolute precision.

\subsubsection{Receiver Time}
Receiver Time is a time that is kept by the GPS receiver clock.

Receivers are usually equipped only with simple crystal oscillators
and aren't capable of keeping precise time.
This is solved by adding the clock offset as a fourth dimension of the receiver position.
Having clock offset as a part of the navigation solution makes it easy to calculate
precise time after a fix is obtained by adding the offset to the receiver clock.

\subsection{GPS Signals}
GPS signals are transmitted using CDMA.
Each signal at each satellite is assigned a unique pseudo random sequence, called PRN code and the carrier frequency is
modulated using this sequence, possibly mixed with \SI{50}{\bit\per\second} navigation messages, for transmitting
ephemeris and other data (see chapter 3 of \cite{rizos99}).

Legacy GPS satellites work on two frequencies, primary L1 (\SI{1575.42}{\mega\hertz}) and secondary L2 (\SI{1227.6}{\mega\hertz}).
Unencrypted \SI{1}{\mega\hertz} C/A code is transmitted on L1, and encrypted military \SI{10}{\mega\hertz} P(Y) code is transmitted
on both L1 and L2.

One of the main advantages of multiple frequencies is the ability to calculate corrections for ionospheric delays from the received signals.
To use this feature without encryption keys for the P(Y) codes, codeless techniques have been developed
that use the encrypted stream of P(Y) data and utilize timing of the bit stream.
Semi-codeless techniques further exploit other properties of P(Y) code and its known relationships to C/A codes.

Modernized GPS satellites provide three additional civilian signals:
L2C, L5 and a military signal M. A fourth civilian signal and L1C is planned, that will be compatible with
European navigation system Galileo (see \ref{sec:galileo}).
At the time of this writing, the signals L2C and L5 are partially supported and L1C is still only
planned \cite{gps-modernization-www}.

\subsubsection{PRN Sequences}
As mentioned above, PRN sequences are unique to every signal and every satellite.

C/A codes have a chipping rate -- that is the frequency of PRN code modulated on top
of the carrier wave -- of \SI{1.023}{\mega\hertz} and P(Y) code has a chipping rate
of \SI{10.23}{\mega\hertz}.

Receivers typically employ a number of specialised hardware correlators
that attempt to duplicate the PRN codes and match them to the received signal.
Result of successful matching is an identification of the transmitting satellite,
the transmission time \(\svtxtime\) (appearing in pseudorange definition \eqref{eq:pseudorange})
modulo PRN code length and possibly also phase and Doppler shift of the carrier wave.

\subsection{Reference Frames}

\subsubsection{ECEF}
Earth-centered Earth-fixed is a Cartesian reference frame widely used in the GPS system.
As the name suggests, origin of ECEF is in the Earth's center of mass, the \(XY\) plane coincident
with equatorial plane, \(X\) axis in the direction of
\ang{0} longitude, \(Y\) axis in direction of \ang{0} East and \(Z\) axis going
the direction of geographical North pole.
%Figure \ref{fig:ecef} illustrates 

\begin{figure}[h]
	\centering
	\input{img/ecef.pdf_tex}
	\caption{Diagram of ECEF reference frame.}
	\label{fig:ecef}
\end{figure}

Results of ephemeris calculations are in ECEF coordinates
(see section \ref{sec:gps-ephemeris}) and receiver positions are calculated
in ECEF as well.
All later GPS calculations in this work will be in ECEF reference frame.

\subsubsection{WGS84}
World Geodetic System 1984, defined in \cite{nima04}
serves as Earth model for GPS.
Exact values of the model have been updated several times in the past,
but these changes have been too small to be problematic for most practical
applications.

The WGS84 reference ellipsoid is used to convert between ECEF coordinates and
Latitude/Longitude geodetic coordinates.
Procedure for this conversion can be found in \cite{nima04}.
Height measured from the ellipsoid can be obtained during the conversion,
however historically heights should be measured from sea level.
Sea level roughly corresponds to geoid -- a surface with constant gravity
potential -- also defined in WGS84.

%with semi major axis \(a = \SI{6378137.0}{\meter}\)
%and inverse flattening \(\frac{1}{f} = \frac{a}{a - b} = 298.257223563\).


\subsection{Ephemeris}
\label{sec:gps-ephemeris}

Ephemeris in the context of GPS means data describing satellite positions and velocities
at given time.
Ephemeris data are transmitted in the \SI{50}{\bit\per\second} messages along with the ranging signals,
together with clock offsets and clocks drifts of the satellites
and possibly other data.

Satellite orbits in the ephemeris messages are described using a set of Keplerian orbital parameters.
Since in this work we will be only using ephemeris data in the ECEF reference frame, Keplerian parameter
won't be discussed here.
More details can be found for example in section 3.3.3 of \cite{rizos99}, or in \cite{kaplan06}.

\subsubsection{Precise Ephemeris}
Precise ephemeris are satellite ephemeris data calculated by ground stations
and distributed separately from the GPS broadcast.

One of sources of precise ephemeris is for example \cite{orbit-data}, providing datasets with
ost-processed data and also with predictions for next several hours.
While the quality of these predictions is lower than of the off-line data,
they are still several times more precise than the broadcast ephemerides
(\SI{5}{\centi\meter} RMS versus \SI{100}{\centi\meter} RMS, according to \cite{orbit-data}).

Precise ephemeris files consist of satellite positions in ECEF
coordinates and clock offsets, in 15 minutes intervals and must be interpolated
before using them for navigation \cite{schenewerk03}.

\section{Obtaining Position and Velocity}


\subsection{Pseudorange}
\label{sec:pseudorange}

Pseudorange (\(\rho\)) is a distance corresponding to the time it took the ranging
signal to travel from SV to the receiver, including the clock offsets:
\begin{equation}
	\label{eq:pseudorange}
	\rho = \speedoflight (\recrxtime - \svtxtime)
\end{equation}
Here \(\speedoflight\) is the speed of light, with value \SI{299792458}{\meter\per\second} used in GPS,
\(\systxtime\) and \(\sysrxtime\) are transmission and receive times referenced to GPS system time.
Similarly \(\svtxtime\) is transmit time according to satellite clock and
\(\recrxtime\) is a receive times according to receiver's clock.
Additionally, \(\svclockoffset\) and \(\recclockoffset\) will stand for the clock offset of the satellite
and of the receiver, \(\geomrange\) for real geometric distance between the satellite and receiver
and \(\geomrangedelays\) for the signal propagation delays.

Especially in context of pseudoranges, GPS literature often treats distance and time
interchangeably, converting between them using the speed of light \(\speedoflight\).
In this work, we will occasionally follow this convention as well.

\begin{figure}[tb]
	\centering
	\input{img/pseudorange.pdf_tex}
	\caption{Times in pseudorange measurements.}
	\label{fig:pseudorange}
\end{figure}

In \eqref{eq:pseudorange}, the definition of pseudorange, the SV and receiver clocks can be
converted to system time by subtracting their clock offsets:
\begin{equation}
	\label{eq:pseudorange2}
	\rho = \speedoflight (\sysrxtime - \systxtime) + \speedoflight (\recclockoffset - \svclockoffset)
\end{equation}
It should be noted that the clock offsets change in time, and that \(\recclockoffset\) is receiver clock
offset in the time of receive and \(\svclockoffset\) applies to the time of transmission.

Real geometric range \(\geomrange\) can be described using the transmit and receive times:
\begin{equation}
	\geomrange + \speedoflight\geomrangedelays = \speedoflight (\sysrxtime - \systxtime)
\end{equation}
where \(\geomrangedelays\) are delays of the signal propagation.
Together with \eqref{eq:pseudorange2}, the previous equation gives us
the basic equation for determining geometric distance from pseudorange measurements:
\begin{equation}
	\geomrange + \speedoflight\geomrangedelays = \rho - \speedoflight (\recclockoffset - \svclockoffset)
\end{equation}

%\begin{equation}
%	\geomrange - \speedoflight \recclockoffset = \rho -
%		\speedoflight \geomrangedelays + \speedoflight \svclockoffset
%\end{equation}

Figure \ref{fig:pseudorange} summarizes relations between times in a single pseudorange measurement.

\subsection{Position}
\label{sec:gps-position}

If the position of satellites \(\svpos_i = \coord{x_{{\SV}i}}{y_{{\SV}i}}{z_{{\SV}i}}\) and satellite
clock offsets \(\svclockoffset_i\) at time of transmission are known,
calculating receiver position from the pseudorange measurements means solving a set of non-linear equations
\begin{equation}
	\label{eq:pseudorange3}
	\sqrt{(x_\REC - x_{{\SV}i})^2 + (y_\REC - y_{{\SV}i})^2 +(z_\REC - z_{{\SV}i})^2} +
	\speedoflight (\recclockoffset - \svclockoffset_i)
	=
	\rho_i - \speedoflight\geomrangedelays_i
\end{equation}
for receiver position \(\recpos = \coord{x_\REC}{y_\REC}{z_\REC}\) and receiver clock offset \(\recclockoffset\).

This can be visualised as intersection of conical surfaces in four dimensions.

Equations from \eqref{eq:pseudorange3} can be solved using various methods, including closed form solutions
(for example \cite{leva96}), iterative solutions, linearization of the equations around
previous position estimates, using Kalman filters (see \ref{sec:kalman}) or,
as we will discuss in section \ref{sec:measurement_domain}, Monte Carlo localization.
The last two approaches also have the advantage of being able to fuse other sensor data
into the solution.

\subsubsection{Carrier Phase Tracking}
\label{sec:gps_carrier_phase}

Carrier phase tracking is a technique that depends on measuring the phase of carrier wave.
L1 frequency has a wavelength of approximately \SI{19}{\centi\meter}.
When the receiver can match the L1 with \SI{1}{\percent} accuracy, then the available precision
is around \SI{2}{\milli\meter} compared to about \SI{3}{\meter} for code phase (pseudorange)
tracking. More detailed description of the code phase tracking errors is in \cref{sec:gps-errors}.

One of the main problems with the carrier phase tracking is integer ambiguity of the carrier wave.
This problem arises because the carrier wave doesn't contain any code designed to resolve
this kind of ambiguity.

Carrier phase measurements can be used to smooth pseudorange data.
Details about this method can be found in section \enquote{Smooth} in \cite{sam-www}.

\subsection{Velocity}
The simplest way of obtaining receiver velocity is as a derivation of
position, which is in turn obtained using one of the methods described in preceding paragraphs.
This has the advantage of requiring only minimum of additional processing.

When the receiver position is known, its velocity can also be obtained from Doppler shift of
the received signal and known velocities of satellites.
Received frequency can be approximated as
\begin{equation}
	f = f_\SV \left(1 - \frac{\recsvvel}{\speedoflight}\right)
	\label{eq:doppler}
\end{equation}
where \(f_\SV\) is the transmitted frequency and \(\recsvvel\) is the relative velocity
between the satellite and the receiver.
The relative velocity can be written as a dot product of unit vector pointing
from user to the satellite and velocity difference between the user and the satellite:
\begin{equation}
	\recsvvel = \frac{
		(\svpos - \recpos)
	}{
		\norm{\svpos - \recpos}
	} \cdot (\svvel - \recvel)
	\label{eq:doppler-velocity}
\end{equation}

When calculating receiver velocities, the measured values also have to be corrected for
clock drifts, both in satellite and in receiver.
Clock drifts are specified in seconds per second and determine the rate of change of clock offset.
Satellite clock drifts are transmitted together with their clock corrections, so we can ignore
them in a similar fashion as satellite clock offsets, but receiver clock drifts must be determined
together with receiver velocity.

The physically received frequency \(f\) is related to the frequency \(f_\REC\) reported by the receiver
using the receiver clock drift \(\recclockdrift\):
\begin{equation}
	f = f_\REC ( 1 + \recclockdrift)
	\label{eq:doppler-clock-drift}
\end{equation}

By putting the equations \eqref{eq:doppler} and \eqref{eq:doppler-clock-drift}
together we obtain
\begin{equation}
	\recsvvel
	=
	\speedoflight \left(1 - \frac{f_\REC}{f_\SV}\right) -
	\speedoflight \frac{f_\REC}{f_\SV} \recclockdrift
\end{equation}

This equation arises for every satellite in view and
as with pseudoranges and positions, there are several ways to obtain the receiver velocity
from them.
In this work we will only use this Doppler measurements as an input to Monte Carlo localisation
and we will not discuss the other methods.\todo{Maybe we won't even use the velocity measurements at all.}

\section{Measurement errors}
\label{sec:gps-errors}

Previous text assumed that all measurements in the GPS system can be made exactly,
but practically all the segments of the GPS system introduce errors.

\subsection{User Equivalent Range Error}
\label{sec:gps-uere}

%\begin{table}[t]
%\centering
%\begin{tabular}{lS}
%\toprule
%	Error Source			& \(1\sigma\) error (\si{\meter}) \\
%\midrule
%	Broadcast clock			& 1.1 \\
%	L1 P(Y)-L1 C/A group delay	& 0.3 \\
%	Broadcast ephemeris		& 0.8 \\
%	Ionospheric delay		& 7.0 \\
%	Tropospheric delay		& 0.1 \\
%	Receiver noise and resolution	& 0.1 \\
%	Multipath			& 0.2 \\
%\midrule
%	Total UERE			& 7.1 \\
%\bottomrule
%\end{tabular}
%\caption{Example GPS error budget.}
%\footnotesize Taken from \cite{kaplan06}
%\label{tab:error-budget}
%\end{table}

User equivalent range error (UERE) characterizes effective accuracy of a pseudorange measurement.
UERE characterized as a sum of errors caused by different parts of the GPS system.

UERE and its components are usually assumed to be zero mean Gaussian variables,
mutually independent both between the error components of a single measurement and between satellites.

\subsection{Dilution of Precision}
\label{sec:gps-dop}

Dilution of precision (DOP) is a value that describes the effects of satellite geometry
on the precision of calculated fix.
There are several types of dilution of precision, specifying errors in different directions.
These are PDOP (position in all directions), HDOP (horizontal error), VDOP (vertical error)
or TDOP (time error).

In theory standard deviation of the completed fix should have a linear dependency on
UERE and DOP (see equation \eqref{eq:dop-def}), but real position error is typically slightly lower,
since the ionospheric errors are correlated.
Measured dependence of position error on HDOP is in \cref{fig:wgs84_hdop_error}.

\subsubsection{Definition}
Formal definition of DOP values is based on linearization of pseudorange equations
in \cref{sec:gps-position}:
\begin{equation}
	\label{eq:dop1}
	\vect{H}\vect{\Delta x} = \vect{\Delta \rho}
\end{equation}
Here \(\vect{H}\) is a matrix of unit vectors pointing from linearization point
to the satellites, \(\vect{\Delta \rho}\) is a vector containing difference between
pseudoranges in linearization point and the real measured pseudoranges and finally
\(\vect{\Delta x}\) is a vector describing the offset of receiver position from the
linearization point.
To simplify the final definitions of DOP values, all calculations here are performed
in a local reference frame with the \(z\) axis pointing up from the linearization point.

Equation \eqref{eq:dop1} is solved for \(\vect{\Delta x}\) using least squares and
as a next step, pseudorange and position errors are taken into account.
This yields an expression relating position error on pseudorange error.
\begin{equation}
	\vect{\delta x} = (\vect{H}^T \vect{H})^{-1} \vect{H}^T \vect{\delta \rho}
\end{equation}
Where \(\vect{\delta x}\) and \(\vect{\delta \rho}\) are position error and pseudorange errors.

As a next step, pseudorange and position errors are taken into account and after
some modifications relations between position and pseudorange error are expressed.
All pseudorange errors are assumed to be independent, Gaussian and identically distributed.

Covariance matrix of \(\vect{\delta x}\) can then be expressed as
\begin{equation}
	\cov(\vect{\delta x}) =
		(\vect{H}^T \vect{H})^{-1} \sigma^2_\UERE =
		\begin{pmatrix}
			\sigma^2_{x}  & \sigma^2_{xy} & \sigma^2_{xz} & \sigma^2_{xt} \\
			\sigma^2_{xy} & \sigma^2_{y}  & \sigma^2_{yz} & \sigma^2_{yt} \\
			\sigma^2_{xz} & \sigma^2_{yz} & \sigma^2_{z}  & \sigma^2_{zt} \\
			\sigma^2_{xt} & \sigma^2_{yt} & \sigma^2_{zt} & \sigma^2_{t}
		\end{pmatrix}
\end{equation}
The covariance matrix only depends on satellite geometry as described by \(\vect{H}\) and UERE.

DOP values are defined as follows:
\begin{subequations}
	\label{eq:dop-def}
\begin{align}
	\sqrt{\sigma^2_x + \sigma^2_y + \sigma^2_z} &= \mathrm{PDOP} \sigma_\UERE \\
	\sqrt{\sigma^2_x + \sigma^2_y} &= \HDOP \sigma_\UERE \\
	\sqrt{\sigma^2_z} &= \mathrm{VDOP} \sigma_\UERE \\
	\sqrt{\sigma^2_t} / \speedoflight &= \mathrm{TDOP} \sigma_\UERE
\end{align}
\end{subequations}

\subsubsection{DRMS}
Distance root mean square is an accuracy metric somewhat similar to
standard deviation of a distribution.
It is a single value describing the accuracy of a 2D position fix.

DRMS is defined as
\begin{equation}
	\mathrm{DRMS} = \sqrt{E(\norm{\vect{\delta R}}^2)}
\end{equation}
where \(\vect{\delta R}\) is a horizontal component of the position error.

Theoretically DRMS can be obtained from HDOP values:
\begin{equation}
	\mathrm{DRMS} = \HDOP \sigma_\UERE
\end{equation}

\cite{www-wilson} offers an alternative expression for obtaining
DRMS from HDOP:
\begin{equation}
	\mathrm{DRMS} = \sqrt{(a \HDOP)^2 + b^2)}
\end{equation}
with \(a\) and \(b\) are parameters that are fitted to measured data.
In \cref{sec:wgs84_hdop_error} we show how this expression fits our experimental data.

\(2 \times \mathrm{DRMS}\) is often used as an approximation for a radius containing
\SI{95}{\percent} of measurements.

\subsection{Error sources}

The following text describes major sources of the measurement errors and when possible
also how to remove the error.
Other than errors mentioned in this section there are many more sources, but they cause inaccuracies
that are negligible for single receiver applications discussed in this thesis.
Overview can be found in \cite{kouba09}.

%Table \ref{tab:error-budget} contains example of error sizes, that are taken from
%\cite{kaplan06}.
%\todo{wtf is group delay?}
%Values in this table are a little bit outdated due to development in both GPS space
%segment and user receivers, but we include it, because breakdown of error values is otherwise hard to measure
%without specialised hardware.

\subsubsection{Match Accuracy and Receiver Delays}

When the receiver is matches the received signal to expected PRN codes an 
important question arises of how accurate the matching is.
Often cited value is \SI{1}{\percent}, which for \SI{1.023}{\mega\hertz}
chipping rate gives about \SI{2.9}{\meter}.
This kind of errors can be improved by smoothing with carrier phase measurements (see
\cref{sec:gps_carrier_phase}).

Delays also occur in receiver signal processing, both in the electronics and in software,
but if these delays are constant for all pseudorange measurements, they will be removed
together with receiver clock delay.

\subsubsection{Multipath}

\begin{figure}[t]
	\centering
	\input{img/multipath.pdf_tex}
	\caption{Multipath and shadowing.}
	\label{fig:multipath}
\end{figure}

Multipath errors arise when the signal from satellite reaches the receiver
through multiple paths of different length.
They are typically caused by buildings surrounding the receiver position,
reflective surfaces surrounding the antenna (e.g. wings in aircraft mounted GPS) or earth surface
when including satellites with low elevation angle.

An illustration of this effect and of shadowing is shown in \cref{fig:multipath}.
Signal drawn in green follows a direct path from the satellite to the receiver and is shadowed,
and red multipath signal is reflected from a building, making its travelled path longer.

If the signal following the direct path is received, GPS receivers can easily detect and remove large delays caused by multipath.
A more problematic case arises when the multipath delay is relatively small, because this distorts
receiver's attempts to correlate the received signal with the internal reference signal.

Shadowing is another phenomenon related to multipath, caused by the signal passing through obstacles, like buildings or foliage.
Shadowing combined with multipath affects relative received power of direct and multipath signals, in extreme cases
even causing the multipath to be the only received signal from given satellite.

Multipath errors can be mitigated with hardware modifications, like antenna designs that suppress signals from suspicious angles,
better antenna placement or coating nearby reflective surfaces with RF absorptive materials.
Another option is to employ better signal processing in receivers.

When only complete measurements are available (as is be the case in the implementation part of this thesis),
satellites may be dropped from the solution if the elevation angle
is too low to avoid this kind of errors.
More involved method of dealing with multipath errors is described in \cite{viandier08},
where the error model of a satellite measurement is modified if it is suspected to be corrupted
by multipath error.

Section 6.3 of \cite{kaplan06} contains detailed discussion of multipath.

\subsubsection{Atmospheric Delays}

GPS signals experience delays when travelling through the atmosphere.
%For the purposes of GPS they are divided into tropospheric and ionospheric delays.

\paragraph{Tropospheric Delays}
Tropospheric delays describe signal delays in the non-ionized layers of Earth's atmosphere.

Troposphere is the non-ionized layer of atmosphere from Earth surface to
approximately \SI{8}{\kilo\meter}.
The stratosphere -- another non-ionized layer of atmosphere -- causes the same
type of delays and is usually included in the therm tropospheric delay.

Tropospheric delays are modelled as consisting of a wet and dry components,
and when left uncompensated, they amount to between \SI{2.4}{\meter} and \SI{25}{\meter}
depending on satellite elevation angle, the dry component
responsible for about \SI{90}{\percent} of the delay \cite{kaplan06}.

There are several models for estimating tropospheric delays depending on satellite
elevation angle, altitude of the receiver, atmospheric pressure, temperature and
water vapour pressure.

In the implementation part of this work we use model outlined in \cite{navipedia-tropospheric}
with hard-coded values for meteorologic parameters.

\paragraph{Ionospheric Delays}

Tropospheric delays are relatively small and can be relatively easily estimated based on satellite elevation
angle\todo{Citation needed. And some equations.}, but ionospheric errors are much larger and harder to predict.

Multi frequency receivers can calculate ionospheric delays by comparing the two received signals.
Delay models for for ionosphere that can be used in a single frequency receiver also exist,
but they are not very reliable.

An interesting property of ionospheric delays is, that they are correlated,
both in measurements from different satellite to a single receiver and in measurements
from a single satellite to multiple receivers.
The later property is utilized in differential GPS (\cref{sec:dgps}).\todo{Add citations, expand}


\subsubsection{Ephemeris Errors and SV Clock Errors}

When the receiver relies on the transmitted ephemeris and satellite clock corrections,
it is also affected by errors in these values.

The errors are periodically corrected by the control segment, but between the updates the error
increases as the data age.
\todo{expand, add citations}

This class of errors can be avoided or at least decreased by using precise ephemeris (see \cref{sec:gps-ephemeris})
at the expense of requiring internet connection during operation.

\subsubsection{Relativistic Errors}
\todo{Write something here!}

\section{Kalman Filters}
Kalman filters are often used in the GPS receivers to merge past
data with incoming measurements or to combine the GPS position and velocity
estimation with another source of measurements, for example inertial data.

For more detailed description of how Kalman filters operate see section
\ref{sec:kalman}.

\section{Differential GPS}
\label{sec:dgps}

Differential GPS is a method to improve GPS accuracy using at least one reference station.
DGPS exploit the correlations of GPS errors and is capable of removing or decreasing satellite clock errors,
ephemeris errors, tropospheric and ionospheric errors.

DGPS systems may operate with baseline distances from a hundreds of meters to several thousand kilometers,
may be used to calculate precise absolute positions or positions relative to positions.
Accuracy of DGPS may range from several decimeters for code based systems to several
millimeters for carrier based systems.

Reference stations must feed its data to the receivers, which use it to correct their own measurements.
This need of infrastructure and reliable wireless connection makes DGPS impractical for many uses.

%\cite{dana99}

Differential GPS is often used in surveying (off-line, high precision) and this
use is discussed in \cite{rizos99}.

\section{Assisted GPS}
Assisted GPS refers to techniques used typically on PDAs and cell phones, that improve operation of GPS by offloading
work from the receiver chip to a remote assistance server.

Assistance server has a good satellite reception and more computing power than the device
and can supply the client system with complete position fixes based on uploaded GPS signal sample,
ephemeris data which can then be used to speed up cold start of the client device or
ionospheric parameters, forming simple DGPS system and increasing the fix precision.

%\section{GPS Receivers}

%As stated before, this work focuses on low cost consumer grade receivers.
%There are currently many different receiver chips available, differing in

\section{Protocols}
Most of the time a consumer GPS receivers is used as a black box that given power and possibly antenna connection
provides position estimates.
In more complicated use cases, such as measurement domain integration of GPS signals with
other sensors discussed in section \ref{sec:measurement_domain} of this work,
lower level data from the location estimation process are used, but only as provided
by software in the GPS receiver.
Many communication protocols providing position, velocity, clock data
and other information are in use.

\subsection{NMEA 0183}
NMEA 0183 is a de-facto standard protocol for consumer grade GPS receivers.
It is a text-based proprietary format developed by National Marine Electronics Organization,
but has been reverse engineered and the specification is known \cite{depriest}.

The protocol by itself is designed for communication of marine electronic
equipment and isn't specific to GPS receivers.
It consists of a large number of sentences, some of which are intended to be used
for position, velocity and time solutions of GPS navigation.

Problem with NMEA protocol is, that a different subset is implemented in almost every
receiver and there is no access to lower levels of the GPS signal processing.

\subsection{Proprietary Protocols}
Many GPS receivers extend the NMEA protocol using proprietary sentences or
implement a custom protocols.
Example of this is the SiRF binary protocol \cite{sirf-protocol}.

Often the use of proprietary protocol is the only way to get complete functionality from
the receiver.

\subsection{RINEX}

The Receiver Independent Exchange Format \cite{rinex-format} is an exchange format
for GPS and other satellite navigation systems.

RINEX is typically used for post processing as it can contain various data that are not
known during navigation, for example detailed ionospheric models, or high precision ephemeris.

\section{Similar Systems}

GPS is not the only GNSS currently operational.
%Other countries than USA have also created navigation systems, but the major advantage of
%GPS is that it i

GLONASS \cite{glonass} is a Russian navigation system, similar in principle with GPS.
It is currently undergoing a modernization and is planned to be compatible with GPS and Galileo.

Another example of current GNSS system is the Chinese BeiDou.
BeiDou uses two way distance measurements, which is a major difference from GPS and the other navigation
systems mentioned in this section.
This bidirectional system has the advantage of adding an ability to communicate between the
users and the control center in addition to dissemination of precision time and position.
BeiDou is currently in development and only three satellites have been launched so far.


\subsection{Galileo}
\label{sec:galileo}

Galileo \cite{galileo} is a project by European Union to create a global navigation system, which
probably is of the most interest to GPS users.

It is designed to be independent of GPS and offer multiple levels of access worldwide
including an open access navigation, however
it will be compatible with GPS receivers that support the modernized L1C signals.
Galileo constellation will consist of 30 satellites, and will provide several types of services,
from free public service to including safety-critical.

Technically, Galileo is fairly similar to GPS,
compatibility is provided by using the same geodetic and time reference frames
and, as mentioned above, by using a signal compatible with the GPS L1C.
This means, that GPS receiver supporting this signal will be able to seamlessly
use both systems combined.

Moreover measurements from Galileo satellites will suffer from the same errors as
their GPS counterparts, which makes this system interchangeable withe GPS for the purposes
of this work.
