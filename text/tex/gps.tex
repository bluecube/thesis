\chapter{GPS}
\label{chap:gps}

This chapter contains a overview of Global Positioning System and
its basic operation.
Next it describes methods of obtaining receiver position and velocity,
error sources of GPS measurements and methods of dealing with these errors.
Lastly it discusses properties of consumer grade GPS receivers.

Global Positioning System is a global navigation satellite system (GNSS)
developed and operated by U.S. military.
GPS provides three dimensional position and velocity measurements as well as
precise time source for every place on earth with direct satellite visibility.

GPS consists of a constellation of at least 24 satellites (space vehicles, SVs),
control segment and end-user receivers.

\begin{itemize}
\item The satellites are orbiting approximately \SI{20200}{km} above earth surface.
\item 6 nearly circular orbits
\item Ongoing modernization

\item Control segment consists of a network of ground facilities and is responsible for
monitoring the satellite constellation and send commands and data to the satellites,

\item There are several GPS signals with different properties
and more will become available with modernized satellites,
however all these signals can be divided to encrypted military signals 
(Precise Positioning Service) and unencrypted
civilian signals (Standard Positioning Service).

The unencrypted signals are available worldwide without any limitations,
however they are also susceptible to spoofing attacks, however complicated these are
\cite{tippenhauer11}.

\end{itemize}

%\section{History}
%Prior to development of GPS, a satellite navigation system called Transit was operational
%since 1964.
%Transit measured 2D positions of stationary or slow moving receivers based on
%Doppler shifts of the satellite signal \cite{transit-www}.


\section{Operation Principles}

\subsection{Time of Arrival measurements}

GPS calculates position by measuring the time it takes for a signal
emitted from a known position to reach reach the receiver.

Each GPS satellite transmits a pseudo random sequence (PRN signal),
containing timing information.
The receiver is able to replicate and match this sequence and therefore
is able to determine the transmission time of the signal.

If the position of satellites is known and all clock in the system are
synchronized, the position of the receiver
can be calculated as an intersection of at least three spheres centered around the satellites
and with radius corresponding to signal time of flight.

In reality, receiver clock offset needs to be calculated
during localization witch adds a new dimension to position determination.

\subsection{Time and GPS}

One of the functions of GPS system is a dissemination of precise time.
%This is necessary to calculate position

There are three basic time frames appearing in the GPS system.

\subsubsection{GPS System Time}

GPS System Time is a paper time scale based on atomic clock standards in GPS
satellites and on the ground.
This time standard is not directly available neither in SVs or in user receivers.

It is specified by a week number -- number of Saturday/Sunday midnights since week 0
that started on January, 6th 1980 -- and time of week in seconds.

GPS system time is related to UTC.
It is a continuous time scale, not adjusted for leap seconds
and it is required to be within \SI{1}{\micro\second} from UTC modulo \SI{1}{\second}.

\subsubsection{SV Time}
SV Time is a value that satellites transmit in their ranging signals,
obtained from the satellite's atomic clock.
Although the atomic clock standards are highly stable, the offset between SV
Time and GPS System Time may reach up to \SI{1}{\milli\second} (equivalent to
\SI{300}{\kilo\meter} of measurement error).

Values of this offset are calculated by the control segment
and broadcast by the satellites, or downloaded with precise ephemeris
(see section \ref{sec:gps-ephemeris}).
Because of this we can assume that this value is known, although not
with absolute precision.

\subsubsection{Receiver Time}
Receiver Time is a time that is kept by the GPS receiver clock.

Receivers are usually equipped only with simple crystal oscillators
and aren't capable of keeping precise time.
This is solved by adding the clock offset as a fourth dimension of the receiver position.
Having clock offset as a part of the navigation solution makes it easy to calculate
precise time after a fix is obtained by adding the offset to the receiver clock.

\subsection{PRN signals}
GPS signals utilize CDMA to transmit its navigation messages.

Each signal at each satellite is assigned a unique pseudo random sequence, called PRN
code.
Receivers then typically employ a number of specialised hardware correlators, 
that attempt to duplicate the PRN codes and match them to the received signal.
Result of successful matching is an identification of the transmitting satellite
and the transmission time \(\svtxtime\) (appearing in pseudorange definition \eqref{eq:pseudorange})
modulo PRN code length.

Legacy GPS signals are tramsited on two frequencies, primary L1 and secondary L2.
Unencrypted C/A code on L1, and encrypted P(Y) on both L1 and L2, because the dual
frequencies enable the receiver to calculate corrections for ionospheric delays.
The L1 C/A code and one of the P(Y) codes are additionally modulated with
\SI{50}{\bit\per\second} navigation messages.

Modernized GPS satellites provide two additional civilian signals --
L2C, L5 and planned L1C, that will be compatible with European navigation system Galileo
(see \ref{sec:galileo}) -- and modernized military signal M.
At the time of this writing, the signals L2C and L5 are partially supported and L1C is still only
planned \cite{gps-modernization-www}.

\subsection{Reference Frames}

\subsubsection{ECEF}
Earth-centered Earth-fixed is a Cartesian reference frame widely used in the GPS system.
As the name suggests, origin of ECEF is in the Earth's center of mass, the \(XY\) plane coincident
with equatorial plane, \(X\) axis in the direction of
\ang{0} longitude, \(Y\) axis in direction of \ang{0} East and \(Z\) axis going
the direction of geographical North pole.
%Figure \ref{fig:ecef} illustrates 

\begin{figure}[h]
	\centering
	\input{img/ecef.pdf_tex}
	\caption{Diagram of ECEF reference frame.}
	\label{fig:ecef}
\end{figure}

Results of ephemeris calculations are in ECEF coordinates
(see section \ref{sec:gps-ephemeris}) and receiver positions are calculated
in ECEF as well.
All later GPS calculations in this work will be in ECEF reference frame.

\subsubsection{WGS84}
World Geodetic System 1984, defined in \cite{nima04}
serves as Earth model for GPS.
Exact values of the model have been updated several times in the past,
but these changes have been too small to be problematic for most practical
applications.

The WGS84 reference ellipsoid is used to convert between ECEF coordinates and
Latitude/Longitude geodetic coordinates.
Procedure for this conversion can be found in \cite{nima04}.
Height measured from the ellipsoid can be obtained during the conversion,
however historically heights should be measured from sea level.
Sea level roughly corresponds to geoid -- a surface with constant gravity
potential -- also defined in WGS84.

%with semi major axis \(a = \SI{6378137.0}{\meter}\)
%and inverse flattening \(\frac{1}{f} = \frac{a}{a - b} = 298.257223563\).


\subsection{Ephemeris}
\label{sec:gps-ephemeris}

Ephemeris in the context of GPS means data describing satellite positions
at given time.

Along with the ranging signals, GPS satellites transmit messages containing ephemeris and
clock offsets.
These messages describe the satellite orbit using a set of Keplerian orbital parameters.

\todo{Keplerian parameters? They are unimportant for the thesis, and it takes three
pages to define them properly ... think of something better to write}

\subsubsection{Precise Ephemeris}
Precise ephemeris are satellite ephemeris data calculated by ground stations
and distributed separately from the GPS broadcast.

Source of precise ephemeris is \cite{orbit-data}, providing datasets with
post-processed data and also wiyh predictions for next several hours.
While the quality of these predictions is lower than of the off-line data,
they are still several times more precise than the broadcast ephemerides
(\SI{5}{\centi\meter} RMS versus \SI{100}{\centi\meter} RMS, according to \cite{orbit-data}).

Precise ephemeris files consist of satellite positions in ECEF
coordinates and clock offsets, in 15 minutes intervals and must be interpolated
before using them for navigation \cite{schenewerk03}.

\section{Obtaining Position and Velocity}


\subsection{Pseudorange}
\label{sec:pseudorange}

Pseudorange (\(\rho\)) is a distance corresponding to the time it took the ranging
signal to travel from SV to the receiver, including the clock offsets:
\begin{equation}
	\label{eq:pseudorange}
	\rho = \speedoflight (\recrxtime - \svtxtime)
\end{equation}
Here \(\speedoflight\) is the speed of light, with value \SI{299792458}{\meter\per\second} used in GPS,
\(\systxtime\) and \(\sysrxtime\) are transmission and receive times referenced to GPS system time.
Similarly \(\svtxtime\) is transmit time according to satellite clock and
\(\recrxtime\) is a receive times according to receiver's clock.
Additionally, \(\svclockoffset\) and \(\recclockoffset\) will stand for the clock offset of the satellite
and of the receiver, \(\geomrange\) for real geometric distance between the satellite and receiver
and \(\geomrangedelays\) for the signal propagation delays.

In context of pseudoranges, GPS literature often treats distance and time
interchangeably, converting between them using the speed of light \(\speedoflight\).
In this work, we will occasionally follow this convention as well.

\begin{figure}[tb]
	\centering
	\input{img/pseudorange.pdf_tex}
	\caption{Times in pseudorange measurements.}
	\label{fig:pseudorange}
\end{figure}

In \eqref{eq:pseudorange}, the definition of pseudorange, the SV and receiver clocks can be
converted to system time by subtracting their clock offsets:
\begin{equation}
	\label{eq:pseudorange2}
	\rho = \speedoflight (\sysrxtime - \systxtime) + \speedoflight (\recclockoffset - \svclockoffset)
\end{equation}
The real range can be described using the transmit and receive times:
\begin{equation}
	\geomrange + \speedoflight\geomrangedelays = \speedoflight (\sysrxtime - \systxtime)
\end{equation}
And this can be substituted into \eqref{eq:pseudorange2}, giving us
\begin{equation}
	\rho = \geomrange + \speedoflight\geomrangedelays + \speedoflight (\recclockoffset - \svclockoffset)
\end{equation}

%\begin{equation}
%	\geomrange - \speedoflight \recclockoffset = \rho -
%		\speedoflight \geomrangedelays + \speedoflight \svclockoffset
%\end{equation}

Figure \ref{fig:pseudorange} summarizes relations between times in a single pseudorange measurement.

\subsection{Position}

If the position of satellites \(\coord{x_{\mathrm{SV}i}}{y_{\mathrm{SV}i}}{z_{\mathrm{SV}i}}\) and satellite
clock offsets \(\svclockoffset_i\) are known,
calculating receiver position from the pseudorange measurements means solving a set of non-linear equations
\begin{equation}
	\sqrt{(x_\mathrm{R} - x_{\mathrm{SV}i})^2 + (y_\mathrm{R} - y_{\mathrm{SV}i})^2 +(z_\mathrm{R} - z_{\mathrm{SV}i})^2} +
	\speedoflight (\recclockoffset - \svclockoffset_i)
	=
	\rho_i - \speedoflight\geomrangedelays_i
\end{equation}
for receiver position \(\coord{x_\mathrm{R}}{y_\mathrm{R}}{z_\mathrm{R}}\) and receiver clock offset \(\recclockoffset\).

These equations can be solved using various methods, including closed form solutions
(for example \cite{leva96}), iterative solutions, linearization of the equations around
previous position estimates, using Kalman filters (see \ref{sec:kalman}) or,
as we will discuss in section \ref{sec:measurement_domain}, Monte Carlo localization.
The last two approaches also have the advantage of being able to fuse other sensor data
into the solution.

\todo{Expand}

\subsection{Velocity}
\begin{itemize}
\item More math
\end{itemize}

\section{Measurement errors}
\label{sec:gps-errors}
\begin{itemize}
\item Describe UERE
\item describe DOP
\label{sec:gps-dop}
\end{itemize}

\begin{itemize}
\item Multipath
\item Ionospheric \& tropospheric delays
\item Ephemeris errors (+ precise ephemeris web sources)
\item SV clock errors
\end{itemize}

\subsection{Dilution of Precision}
\begin{itemize}
\item effect of satellite geometry on position error
\end{itemize}

\section{Kalman Filters}
Kalman filters are often used in the GPS receivers to merge past
data with incoming measurements or to combine the GPS position and velocity
estimation with another source of measurements, for example inertial data.

For more detailed description of how Kalman filters operate see section
\ref{sec:kalman}.

\section{Differential GPS}
\begin{itemize}
\item Very briefly; won't be used anywhere further
\item SBAS ?
\end{itemize}

\subsection{Carrier phase}
\url{http://www.colorado.edu/geography/gcraft/notes/gps/gps_f.html}


\section{Assisted GPS}


\section{GPS Receivers}
\subsection{Protocols}
\subsubsection{NMEA}
\subsection{RINEX}
\subsubsection{Proprietary Protocols}

\section{Similar Systems}

\begin{itemize}
\item Glonass
\item BeiDou
\item Compass
\end{itemize}

\subsection{Galileo}
\label{sec:galileo}
